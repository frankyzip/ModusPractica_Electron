<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timezone Fix Test Suite</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #2196F3;
            background: #f9f9f9;
        }
        .test-case.pass {
            border-left-color: #4CAF50;
            background: #f1f8f4;
        }
        .test-case.fail {
            border-left-color: #f44336;
            background: #fef1f0;
        }
        .test-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .test-result {
            font-family: monospace;
            font-size: 13px;
            color: #555;
            margin-top: 8px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        .summary {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .summary-card {
            flex: 1;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        .summary-card.passed {
            background: #4CAF50;
        }
        .summary-card.failed {
            background: #f44336;
        }
        .summary-card.total {
            background: #2196F3;
        }
        .summary-label {
            font-size: 14px;
            font-weight: normal;
            margin-top: 5px;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üåç Timezone-Safe Date Handling Test Suite</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
        <button onclick="clearResults()" class="secondary">üóëÔ∏è Clear Results</button>
        <button onclick="exportResults()" class="secondary">üíæ Export Results</button>
    </div>

    <div class="summary" id="summary" style="display: none;">
        <div class="summary-card total">
            <div id="totalTests">0</div>
            <div class="summary-label">Total Tests</div>
        </div>
        <div class="summary-card passed">
            <div id="passedTests">0</div>
            <div class="summary-label">Passed</div>
        </div>
        <div class="summary-card failed">
            <div id="failedTests">0</div>
            <div class="summary-label">Failed</div>
        </div>
    </div>

    <div class="test-section">
        <h2>1. Core Utility Function Tests</h2>
        <div id="utilityTests"></div>
    </div>

    <div class="test-section">
        <h2>2. Timezone Edge Case Tests</h2>
        <div id="timezoneTests"></div>
    </div>

    <div class="test-section">
        <h2>3. Date Comparison Tests</h2>
        <div id="comparisonTests"></div>
    </div>

    <div class="test-section">
        <h2>4. Data Migration Tests</h2>
        <div id="migrationTests"></div>
    </div>

    <script src="moduspractica-utils.js"></script>
    <script>
        let testResults = [];

        function runTest(name, testFn, containerId) {
            const container = document.getElementById(containerId);
            const testDiv = document.createElement('div');
            testDiv.className = 'test-case';
            
            try {
                const result = testFn();
                const passed = result.passed;
                testDiv.classList.add(passed ? 'pass' : 'fail');
                
                testDiv.innerHTML = `
                    <div class="test-title">${passed ? '‚úÖ' : '‚ùå'} ${name}</div>
                    <div class="test-result">${result.message}</div>
                `;
                
                testResults.push({ name, passed, message: result.message });
            } catch (error) {
                testDiv.classList.add('fail');
                testDiv.innerHTML = `
                    <div class="test-title">‚ùå ${name}</div>
                    <div class="test-result">Error: ${error.message}</div>
                `;
                testResults.push({ name, passed: false, message: error.message });
            }
            
            container.appendChild(testDiv);
        }

        function runAllTests() {
            testResults = [];
            clearResults();
            
            // 1. Utility Function Tests
            runTest('getTodayLocal() returns date at midnight', () => {
                const today = getTodayLocal();
                const passed = today.getHours() === 0 && today.getMinutes() === 0 && today.getSeconds() === 0;
                return {
                    passed,
                    message: `Result: ${today.toISOString()} (Hours: ${today.getHours()}, Minutes: ${today.getMinutes()}, Seconds: ${today.getSeconds()})`
                };
            }, 'utilityTests');

            runTest('toDateOnly() strips time component', () => {
                const dateWithTime = new Date('2025-01-15T14:30:45Z');
                const dateOnly = toDateOnly(dateWithTime);
                const passed = dateOnly.getHours() === 0 && dateOnly.getMinutes() === 0 && dateOnly.getSeconds() === 0;
                return {
                    passed,
                    message: `Input: ${dateWithTime.toISOString()}\nOutput: ${dateOnly.toISOString()}`
                };
            }, 'utilityTests');

            runTest('isSameDay() correctly identifies same calendar day', () => {
                const date1 = new Date('2025-01-15T08:00:00Z');
                const date2 = new Date('2025-01-15T20:00:00Z');
                const date3 = new Date('2025-01-16T08:00:00Z');
                const test1 = isSameDay(date1, date2);
                const test2 = !isSameDay(date1, date3);
                const passed = test1 && test2;
                return {
                    passed,
                    message: `Same day (different times): ${test1}\nDifferent days: ${!test2 ? 'FAIL' : 'OK'}`
                };
            }, 'utilityTests');

            runTest('daysBetween() calculates correct difference', () => {
                const date1 = new Date('2025-01-15');
                const date2 = new Date('2025-01-20');
                const diff = daysBetween(date1, date2);
                const passed = diff === 5;
                return {
                    passed,
                    message: `From ${date1.toDateString()} to ${date2.toDateString()}: ${diff} days (expected 5)`
                };
            }, 'utilityTests');

            runTest('addDays() adds correct number of days', () => {
                const start = new Date('2025-01-15');
                const result = addDays(start, 7);
                const expected = new Date('2025-01-22');
                const passed = isSameDay(result, expected);
                return {
                    passed,
                    message: `Start: ${formatDateYMD(start)}, Add 7 days: ${formatDateYMD(result)} (expected ${formatDateYMD(expected)})`
                };
            }, 'utilityTests');

            runTest('formatDateYMD() and parseDateYMD() round-trip correctly', () => {
                const original = '2025-01-15';
                const parsed = parseDateYMD(original);
                const formatted = formatDateYMD(parsed);
                const passed = original === formatted;
                return {
                    passed,
                    message: `Original: ${original}, Parsed & Formatted: ${formatted}`
                };
            }, 'utilityTests');

            // 2. Timezone Edge Case Tests
            runTest('Dates across DST boundary', () => {
                // Test dates before and after DST change
                const beforeDST = new Date('2025-03-08T08:00:00');
                const afterDST = new Date('2025-03-10T08:00:00');
                const diff = daysBetween(beforeDST, afterDST);
                const passed = diff === 2;
                return {
                    passed,
                    message: `Days between DST boundary: ${diff} (expected 2)`
                };
            }, 'timezoneTests');

            runTest('Date at midnight in different timezones', () => {
                const utcMidnight = new Date('2025-01-15T00:00:00Z');
                const localMidnight = toDateOnly(utcMidnight);
                const sameDay = isSameDay(utcMidnight, localMidnight);
                // This should be true regardless of timezone since we're comparing date-only
                return {
                    passed: sameDay,
                    message: `UTC midnight and local midnight are same day: ${sameDay}`
                };
            }, 'timezoneTests');

            runTest('Year boundary handling', () => {
                const dec31 = new Date('2024-12-31T23:59:59');
                const jan1 = new Date('2025-01-01T00:00:01');
                const diff = daysBetween(dec31, jan1);
                const passed = diff === 1;
                return {
                    passed,
                    message: `Days from Dec 31 to Jan 1: ${diff} (expected 1)`
                };
            }, 'timezoneTests');

            // 3. Date Comparison Tests
            runTest('isToday() correctly identifies today', () => {
                const today = getTodayLocal();
                const tomorrow = addDays(today, 1);
                const yesterday = addDays(today, -1);
                
                const todayCheck = isToday(today);
                const tomorrowCheck = !isToday(tomorrow);
                const yesterdayCheck = !isToday(yesterday);
                const passed = todayCheck && tomorrowCheck && yesterdayCheck;
                
                return {
                    passed,
                    message: `Today: ${todayCheck}, Tomorrow: ${!tomorrowCheck ? 'FAIL' : 'OK'}, Yesterday: ${!yesterdayCheck ? 'FAIL' : 'OK'}`
                };
            }, 'comparisonTests');

            runTest('isPastDate() correctly identifies past dates', () => {
                const today = getTodayLocal();
                const yesterday = addDays(today, -1);
                const tomorrow = addDays(today, 1);
                
                const yesterdayPast = isPastDate(yesterday);
                const todayPast = !isPastDate(today);
                const tomorrowPast = !isPastDate(tomorrow);
                const passed = yesterdayPast && todayPast && tomorrowPast;
                
                return {
                    passed,
                    message: `Yesterday is past: ${yesterdayPast}, Today is past: ${!todayPast ? 'FAIL' : 'OK'}, Tomorrow is past: ${!tomorrowPast ? 'FAIL' : 'OK'}`
                };
            }, 'comparisonTests');

            runTest('isFutureDate() correctly identifies future dates', () => {
                const today = getTodayLocal();
                const tomorrow = addDays(today, 1);
                const yesterday = addDays(today, -1);
                
                const tomorrowFuture = isFutureDate(tomorrow);
                const todayFuture = !isFutureDate(today);
                const yesterdayFuture = !isFutureDate(yesterday);
                const passed = tomorrowFuture && todayFuture && yesterdayFuture;
                
                return {
                    passed,
                    message: `Tomorrow is future: ${tomorrowFuture}, Today is future: ${!todayFuture ? 'FAIL' : 'OK'}, Yesterday is future: ${!yesterdayFuture ? 'FAIL' : 'OK'}`
                };
            }, 'comparisonTests');

            // 4. Data Migration Tests
            runTest('normalizeDateForStorage() handles various formats', () => {
                // Test different input formats
                const isoString = '2025-01-15T14:30:00.000Z';
                const dateObject = new Date('2025-01-15T14:30:00Z');
                const timestamp = dateObject.getTime();
                
                const norm1 = normalizeDateForStorage(isoString);
                const norm2 = normalizeDateForStorage(dateObject);
                const norm3 = normalizeDateForStorage(timestamp);
                
                // All should normalize to date-only ISO strings
                const date1 = new Date(norm1);
                const date2 = new Date(norm2);
                const date3 = new Date(norm3);
                
                const passed = isSameDay(date1, date2) && isSameDay(date2, date3);
                
                return {
                    passed,
                    message: `ISO: ${norm1.substring(0, 10)}\nDate Object: ${norm2.substring(0, 10)}\nTimestamp: ${norm3.substring(0, 10)}\nAll same day: ${passed}`
                };
            }, 'migrationTests');

            runTest('Legacy date format conversion', () => {
                // Simulate legacy date format (ISO string with time)
                const legacyDate = '2025-01-15T14:30:00.000Z';
                const normalized = normalizeDateForStorage(legacyDate);
                const parsed = new Date(normalized);
                
                // Should be at midnight local time
                const atMidnight = parsed.getHours() === 0 || parsed.getUTCHours() === 0;
                
                return {
                    passed: atMidnight,
                    message: `Legacy: ${legacyDate}\nNormalized: ${normalized}\nAt midnight: ${atMidnight}`
                };
            }, 'migrationTests');

            // Update summary
            updateSummary();
        }

        function clearResults() {
            document.getElementById('utilityTests').innerHTML = '';
            document.getElementById('timezoneTests').innerHTML = '';
            document.getElementById('comparisonTests').innerHTML = '';
            document.getElementById('migrationTests').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
        }

        function updateSummary() {
            const total = testResults.length;
            const passed = testResults.filter(r => r.passed).length;
            const failed = total - passed;
            
            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('summary').style.display = 'flex';
        }

        function exportResults() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const report = {
                timestamp,
                summary: {
                    total: testResults.length,
                    passed: testResults.filter(r => r.passed).length,
                    failed: testResults.filter(r => !r.passed).length
                },
                tests: testResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timezone-test-results-${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
